<!DOCTYPE html>
<html>
    <!-- non framed -->

    <head>
        <title>Students Attendance - Totals</title>
        ~[wc:commonscripts]
        <link href="/images/css/screen.css" rel="stylesheet" media="screen">
        <link href="/images/css/print.css" rel="stylesheet" media="print">
        ~[wc:pscb_init]
        <script>
            pscbToolButtons = { "copyData": "Yes", "csvFile": "Yes", "pdfFile": "Yes", "curSel": "Yes" };
        </script>
    </head>

    <body>
        ~[wc:admin_header_frame_css]
        <!-- breadcrumb start --><a href="/admin/home.html" target="_top">Start Page</a> &gt; <a
            href="/admin/reports_pscb/pscb_home.html" target="_top">PSCB Custom Reports</a> &gt; 
            <a href="/admin/reports_pscb/pscb_attendance.html" target="_top">Attendance</a> &gt; Students Attendance - Totals
        <!-- breadcrumb end -->~[wc:admin_navigation_frame_css]
        <!-- start of Options -->
        <h1>Students Attendance - Totals</h1>
        <form name="searchform" action="#" method="POST">
            <div class="box-round" style="overflow: hidden;">
                <h2>Report Filters</h2>
                <table border="0" cellspacing="0" cellpadding="0" class="linkDescList">
                    <thead>
                        <tr>
                            <th style="white-space: nowrap;" width="180px">Student Selection</th>
                            <th style="white-space: nowrap;" width="90px">Term</th>
                            <th style="white-space: nowrap;" width="180px">Absent Codes</th>
                            <th style="white-space: nowrap;" >Tardy Codes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select name="ss">
                                    <option value='' ~[if.~[gpv:ss]=]selected[/if]>All Students
                                    <option value="cur" ~[if.~[gpv:ss]=cur]selected[/if]>Current Selection
                                        (~[x:studsinset])
                                </select>
                            </td>
                            <td valign="top" nowrap>
                                <select id="term" name="term">
                                    ~[tlist_sql;
                                    SELECT 
                                        terms.id termid, 
                                        CASE 
                                            WHEN terms.id = '~(gpv.term;sqlText)' THEN 'selected'
                                            
                                            ELSE '' 
                                        END isselected, 
                                        Upper(Abbreviation) term 
                                    FROM terms 
                                    WHERE 
                                        terms.schoolid = ~(curschoolid) 
                                        AND terms.yearid = ~(curyearid) 
                                    ORDER BY Upper(Trim(termid))]
                                    <option value="~(termid)" ~(isselected;t)>~(term)</option>
                                    [/tlist_sql]
                                </select>
                            </td>
                            <td>
                                <select name="attc">
                                    <option ~[if.~[gpv:attc]=ABALL]selected[/if] value="ABALL">All Absent Codes</option>
                                    <option ~[if.~[gpv:attc]=ABSUN]selected[/if] value="ABSUN">Absent Unexcused Codes
                                    </option>
                                    <option ~[if.~[gpv:attc]=ABEX]selected[/if] value="ABEX">Absent Excused Codes
                                    </option>
                                    <option ~[if.~[gpv:attc]=ABILL]selected[/if] value="ABILL">Absent Illness Codes
                                    </option>
                                    ~[tlist_sql;
                                    SELECT
                                    DISTINCT Att_Code,
                                    DECODE('~[gpv:attc]', att_code, 'SELECTED', '')isselected,
                                    to_char(Description) description
                                    FROM Attendance_Code
                                    WHERE
                                    yearID = ~(curyearid)
                                    AND schoolID LIKE
                                    CASE
                                    WHEN ~(curschoolid) = 0 THEN '%'
                                    ELSE to_char(~(curschoolid))
                                    END
                                    AND presence_status_cd = 'Absent'
                                    AND att_code is not null
                                    ORDER BY Att_Code ]
                                    <option value="~(Att_Code;t)" ~(isselected)>~(Att_Code;t) (~(description;t))
                                    </option>
                                    [/tlist_sql]
                                </select>
                            </td>
                            <td>
                                <select name="tardy">
                                    <option ~[if.~[gpv:tardy]=]selected[/if]>All Tardy Codes
                                    </option>
                                    <option ~[if.~[gpv:tardy]=TARSUN]selected[/if] value="TARSUN">Tardy Unexcused Codes
                                    </option>
                                    <option ~[if.~[gpv:tardy]=TAREX]selected[/if] value="TAREX">Tardy Excused Codes
                                    </option>
                                    ~[tlist_sql;
                                    SELECT
                                    DISTINCT Att_Code,
                                    DECODE('~[gpv:attc]', att_code, 'SELECTED', '')isselected,
                                    to_char(Description) description
                                    FROM Attendance_Code
                                    WHERE
                                    yearID = ~(curyearid)
                                    AND schoolID LIKE
                                    CASE
                                    WHEN ~(curschoolid) = 0 THEN '%'
                                    ELSE to_char(~(curschoolid))
                                    END
                                    AND att_code is not null
                                    AND att_CODE LIKE 'T%'
                                    AND att_CODE NOT LIKE 'TR%'
                                    AND att_CODE NOT LIKE 'TM%'
                                    ORDER BY Att_Code]
                                    <option value="~(Att_Code;t)" ~(isselected)>~(Att_Code;t) (~(description;t))
                                    </option>
                                    [/tlist_sql]
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="button-row" style="float: left;">
                    <input type="hidden" name="showData" value="1">
                    <span class="red">&nbsp;&nbsp;Select parameters and click submit</span>
                    <input type="hidden" name="ac" value="prim">~[submitbutton]
                </div>
            </div>
        </form>
        <!-- Start of Results -->
        ~[if#showData.~(gpv.showData;sqlText)=1]
        <div class="box-round">
            <h2>Students Attendance - Totals</h2>
            <table border="0" cellspacing="0" cellpadding="4" align="center" class="tablesorter grid" id="results">
                <thead>
                    <tr>
                        <th class="left">Student Number</th>
                        <th class="left">Student Name</th>
                        <th class="left">Exp.</th>
                        <th class="left">Course</th>
                        <th class="left">Absent Count</th>
                        <th class="left">Absent Dates</th>
                        <th class="left">Tardy Count</th>
                        <th class="left">Tardy Dates</th>
                        <th class="left">School</th>
                    </tr>
                </thead>
                <tbody>
                    ~[tlist_sql;
                    WITH DETAILPERIOD AS (
                                            select
                                                students.DCID as sdcid,
                                                students.STUDENT_NUMBER,
                                                students.LASTFIRST,
                                                schools.name as schoolname,
                                                cc.expression,
                                                ac.presence_status_cd AS STATUS,
                                                att.att_date as attdate,
                                                courses.course_name,
                                                ac.att_code,
                                                att.att_mode_code,
                                                att.id AS ATT_ID,
                                                ce.ce_code,
                                                per.abbreviation
                                            from  attendance att
                                            inner join students 
                                                on students.id = att.studentid
                                            inner join schools 
                                                on students.schoolid = schools.school_number
                                            ~[if#ss.~[gpv:ss]=cur] INNER JOIN ~[temp.table.current.selection:students] temp ON (students.dcid = temp.dcid)  [/if#ss]
                                            inner join cc 
                                                on att.ccid = cc.id and att.studentid = cc.studentid
                                            inner join sections s 
                                                on abs(cc.sectionid) = s.id
                                            inner join courses 
                                                on courses.course_number = s.course_number
                                            inner join calendar_day cd 
                                                on att.calendar_dayid = cd.id
                                            inner join attendance_code ac 
                                                on att.attendance_codeid = ac.id
                                            inner join cycle_day cy 
                                                on cd.cycle_day_id = cy.id
                                            inner join att_code_code_entity acce 
                                                on acce.attendance_codeid = ac.id
                                            inner join code_entity ce 
                                                on ce.id = acce.code_entityid
                                            inner join terms t 
                                                on schools.school_number = t.schoolid 
                                                and t.id = ~(gpv.term)
                                            left join period per 
                                                on att.periodid = per.id
                                            where 
                                                att.att_date >= t.firstday 
                                                and att.att_date  < t.lastday
                                                and att.att_mode_code = 'ATT_ModeMeeting'
                                                ~[if.is.a.school] AND schools.school_number = ~(curschoolid) [/if.is.a.school]
                                            order by  schools.name, students.LASTFIRST, att.att_date, per.abbreviation
                                        ),
                    ABSDETAILPERIOD AS (
                                        select
                                            DETAILPERIOD.sdcid,
                                            DETAILPERIOD.STUDENT_NUMBER,
                                            DETAILPERIOD.LASTFIRST,
                                            DETAILPERIOD.schoolname,
                                            DETAILPERIOD.expression,
                                            DETAILPERIOD.STATUS,
                                            DETAILPERIOD.attdate,
                                            DETAILPERIOD.course_name,
                                            DETAILPERIOD.att_code,
                                            DETAILPERIOD.att_mode_code,
                                            DETAILPERIOD.ATT_ID,
                                            DETAILPERIOD.ce_code,
                                            DETAILPERIOD.abbreviation
                                        from  DETAILPERIOD
                                        WHERE
                                            DETAILPERIOD.STATUS = 'Absent'
                                            and TRIM(DETAILPERIOD.ce_code) = 'Unexcused'
                                            ~[decode;~[gpv:attc];ABSUN; and TRIM(DETAILPERIOD.ce_code) = 'Unexcused';ABEX; and TRIM(DETAILPERIOD.ce_code) = 'Excused';ABILL; and TRIM(DETAILPERIOD.ce_code) = 'Illness';ABALL;AND 1=1; AND DETAILPERIOD.att_code = '~[gpv:attc]']
                                        order by  DETAILPERIOD.schoolname, DETAILPERIOD.LASTFIRST, DETAILPERIOD.attdate, DETAILPERIOD.abbreviation
                                        ),
                    ABSPERIODCOUNT AS (
                                    SELECT
                                        LASTFIRST, 
                                        course_name,
                                        count(ATT_ID) as COUNTOFPERIOD
                                    FROM 
                                        ABSDETAILPERIOD
                                    GROUP BY 
                                        LASTFIRST, course_name
                                    ORDER BY 
                                        LASTFIRST
                                    ),
                    ABSLIST as (
                                    SELECT
                                        ABSDETAILPERIOD.sdcid,
                                        ABSDETAILPERIOD.STUDENT_NUMBER,
                                        ABSDETAILPERIOD.LASTFIRST,
                                        ABSDETAILPERIOD.expression,
                                        ABSDETAILPERIOD.course_name,
                                        LISTAGG(ABSDETAILPERIOD.att_code || '-' || to_char(ABSDETAILPERIOD.attDate,'MM/DD/YYYY'), ', ') WITHIN GROUP (ORDER BY ABSDETAILPERIOD.attDate ASC) as ABSDates,
                                        ABSDETAILPERIOD.schoolname
                                    FROM ABSDETAILPERIOD 
                                    group by ABSDETAILPERIOD.sdcid, ABSDETAILPERIOD.STUDENT_NUMBER, ABSDETAILPERIOD.LASTFIRST, ABSDETAILPERIOD.expression, ABSDETAILPERIOD.course_name, ABSDETAILPERIOD.schoolname
                                    )
                    SELECT
                        DETAILPERIOD.sdcid,
                        DETAILPERIOD.STUDENT_NUMBER,
                        DETAILPERIOD.LASTFIRST,
                        DETAILPERIOD.expression,
                        DETAILPERIOD.course_name,
                        ABSPERIODCOUNT.COUNTOFPERIOD,
                        ABSLIST.ABSDates,
                        DETAILPERIOD.schoolname
                    FROM 
                        DETAILPERIOD
                    LEFT OUTER JOIN ABSPERIODCOUNT 
                        ON DETAILPERIOD.LASTFIRST = ABSPERIODCOUNT.LASTFIRST
                        AND DETAILPERIOD.COURSE_NAME = ABSPERIODCOUNT.COURSE_NAME
                    LEFT OUTER JOIN ABSLIST 
                        ON DETAILPERIOD.sdcid = ABSLIST.sdcid
                        AND DETAILPERIOD.COURSE_NAME = ABSLIST.COURSE_NAME
                        AND DETAILPERIOD.expression  = ABSLIST.expression 
                    WHERE 
                        ABSLIST.ABSDates IS NOT NULL
                    GROUP BY 
                        DETAILPERIOD.sdcid, DETAILPERIOD.STUDENT_NUMBER, DETAILPERIOD.LASTFIRST, DETAILPERIOD.expression, DETAILPERIOD.course_name, ABSPERIODCOUNT.COUNTOFPERIOD, DETAILPERIOD.schoolname, ABSLIST.ABSDates
                    ORDER BY 
                        DETAILPERIOD.schoolname, DETAILPERIOD.LASTFIRST, DETAILPERIOD.EXPRESSION
                    ;]
                    <tr data-StudentID="~(dcid)">
                        <td><a href="/admin/students/att_daily.html?frn=001~(dcid)" target="_blank">~(stunum)</a></td>
                        <td class="nowrap">~(stuname;t)</td>
                        <td class="center">~(expression;t;externalExpression)</td>
                        <td>~(coursename)</td>
                        <td class="center">~(abscnt)</td>
                        <td>~(abslist)</td>
                    </tr>
                    [/tlist_sql]
                </tbody>
            </table>
        </div>
        [/if#showData]
        <!-- end of content of bounding box -->
        ~[wc:admin_footer_frame_css]
    </body>

</html><!-- end right frame -->